<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>D!CTATOR</title>

<style>
body{background:black;color:white;font-family:Arial;text-align:center;}
.logoText{font-size:48px;font-weight:bold;margin:20px;animation:shake 2s infinite;}
@keyframes shake{
0%{transform:translate(0)}
25%{transform:translate(1px)}
50%{transform:translate(-1px)}
75%{transform:translate(1px)}
100%{transform:translate(0)}
}
#loginBox input{width:140px;padding:5px;}

table{width:90%;margin:auto;border-collapse:collapse;}
th{background:#111;color:white;padding:8px;border:1px solid #555;}
td{background:white;color:black;padding:6px;border:1px solid #555;}
tfoot td{background:black;color:white;font-weight:bold;}

input{
width:95%;
border:1px solid #aaa;
padding:3px;
text-align:center;
background:white;
box-shadow: inset 0 0 3px #ccc;
}

#table{
user-select:none;
}

#logBox{
display:none;
margin:20px;
border:1px solid #555;
padding:10px;
height:150px;
overflow:auto;
background:#111;
font-size:12px;
text-align:left;
}
</style>
</head>

<body>

<div class="logoText">D<span style="color:red">!</span>CTATOR</div>
<h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏ö‡∏≠‡∏•</h2>

<div id="loginBox">
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<br>

<button id="addBtn" onclick="addDay()" disabled>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô</button>
<button id="saveBtn" onclick="save()" disabled>üíæ Save</button>
<button onclick="toggleLog()">üìú Audit Log</button>

<table id="table">
<thead>
<tr>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th><th>‡∏ó‡∏∏‡∏ô</th><th>‡∏Å‡∏≥‡πÑ‡∏£</th><th>-</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏•‡∏ö‡∏ß‡∏±‡∏ô</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
<td id="sum‡∏ó‡∏∏‡∏ô">0</td>
<td id="sum‡∏Å‡∏≥‡πÑ‡∏£">0</td>
<td id="sum‡∏•‡∏ö">0</td>
<td id="sum‡∏£‡∏ß‡∏°">0</td>
<td></td>
</tr>
</tfoot>
</table>

<h3 id="logTitle" style="display:none">Audit Log</h3>
<div id="logBox"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue, get, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig={
apiKey:"YOUR_KEY",
authDomain:"dictator-ball.firebaseapp.com",
databaseURL:"https://dictator-ball-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"dictator-ball"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const dataRef=ref(db,"table");
const logRef=ref(db,"audit");

const accounts={
"Pim888_":"dictator_888_pim",
"Yohan888_":"dictator_yohan_888",
"Jo888_":"Jo_dictator_888",
"Jwish888_":"dictator_Jwish888_",
"Joommeng_":"Joommeng888"
};

let admin=false;
let currentUser="";
let deviceId=localStorage.getItem("dev")||crypto.randomUUID();
localStorage.setItem("dev",deviceId);

/* ====== ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå ====== */
function updateEditMode(){
let inputs=document.querySelectorAll("#table tbody input");
let buttons=document.querySelectorAll("#table tbody button");

inputs.forEach(i=>{
i.readOnly=!admin;
});

buttons.forEach(b=>{
b.style.display=admin?"inline-block":"none";
});

document.getElementById("table").style.userSelect=admin?"auto":"none";
}

/* ====== Login ====== */
window.login=async function(){
let u=user.value,p=pass.value;
if(accounts[u]!==p){alert("Wrong login");return;}

await set(ref(db,"sessions/"+u),{
device:deviceId,
time:Date.now()
});

admin=true;
currentUser=u;
localStorage.setItem("loginUser",u);

addBtn.disabled=false;
saveBtn.disabled=false;

updateEditMode();
watchSession();
log("LOGIN");
}

/* ====== Logout ====== */
window.logout=async function(){
if(currentUser){
await remove(ref(db,"sessions/"+currentUser));
log("LOGOUT");
}
admin=false;
currentUser="";
localStorage.removeItem("loginUser");

addBtn.disabled=true;
saveBtn.disabled=true;

updateEditMode();
}

/* ====== Force Logout ====== */
function forceLogout(msg){
alert(msg);
admin=false;
currentUser="";
localStorage.removeItem("loginUser");
addBtn.disabled=true;
saveBtn.disabled=true;
updateEditMode();
}

/* ====== Session Watch ====== */
function watchSession(){
onValue(ref(db,"sessions/"+currentUser),(s)=>{
if(!s.exists()){forceLogout("Session ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏");return;}
let data=s.val();
if(data.device!==deviceId){
forceLogout("‡∏°‡∏µ‡∏Ñ‡∏ô login ‡∏ã‡πâ‡∏≥ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ñ‡∏π‡∏Å‡πÄ‡∏ï‡∏∞‡∏≠‡∏≠‡∏Å");
}
});
}

/* ====== Audit ====== */
function log(action){
push(logRef,{user:currentUser,action:action,time:new Date().toLocaleString()});
}

window.toggleLog=function(){
if(!admin) return;
logBox.style.display = logBox.style.display=="none"?"block":"none";
logTitle.style.display = logTitle.style.display=="none"?"block":"none";
}

onValue(logRef,s=>{
if(!admin) return;
let data=s.val(); if(!data) return;
logBox.innerHTML="";
Object.values(data).slice(-20).reverse().forEach(d=>{
logBox.innerHTML+=`<div>[${d.time}] ${d.user} ‚Üí ${d.action}</div>`;
});
});

/* ====== Table ====== */
function fmt(n){return Number(n).toLocaleString();}
function parse(n){return Number(String(n).replace(/,/g,""))||0;}

window.addDay=function(){
if(!admin) return;
let r=document.querySelector("#table tbody").insertRow();
r.innerHTML=`<td><input type=date></td>
<td><input value=0></td>
<td><input value=0></td>
<td><input value=0></td>
<td>0</td>
<td><button onclick="removeRow(this)">X</button></td>`;
log("ADD ROW");
calc();
updateEditMode();
}

window.removeRow=function(b){
if(!admin) return;
b.parentNode.parentNode.remove();
log("DELETE ROW");
calc();
}

function calc(){
let rows=document.querySelectorAll("#table tbody tr");
let s1=0,s2=0,s3=0,s4=0;

rows.forEach(r=>{
let a=parse(r.cells[1].children[0].value);
let b=parse(r.cells[2].children[0].value);
let c=parse(r.cells[3].children[0].value);

r.cells[1].children[0].value=fmt(a);
r.cells[2].children[0].value=fmt(b);
r.cells[3].children[0].value=fmt(c);

let sum=a+b-c;
r.cells[4].innerText=fmt(sum);

s1+=a;s2+=b;s3+=c;s4+=sum;
});

sum‡∏ó‡∏∏‡∏ô.innerText=fmt(s1);
sum‡∏Å‡∏≥‡πÑ‡∏£.innerText=fmt(s2);
sum‡∏•‡∏ö.innerText=fmt(s3);
sum‡∏£‡∏ß‡∏°.innerText=fmt(s4);
}

window.save=function(){
if(!admin) return;
let rows=document.querySelectorAll("#table tbody tr");
let data=[];
rows.forEach(r=>{
data.push({
date:r.cells[0].children[0].value,
‡∏ó‡∏∏‡∏ô:parse(r.cells[1].children[0].value),
‡∏Å‡∏≥‡πÑ‡∏£:parse(r.cells[2].children[0].value),
‡∏•‡∏ö:parse(r.cells[3].children[0].value)
});
});
set(dataRef,data);
log("SAVE TABLE");
alert("Saved!");
}

onValue(dataRef,s=>{
let data=s.val(); if(!data) return;
let tbody=document.querySelector("#table tbody");
tbody.innerHTML="";
data.forEach(d=>{
let r=tbody.insertRow();
r.innerHTML=`<td><input type=date value="${d.date}"></td>
<td><input value="${fmt(d.‡∏ó‡∏∏‡∏ô)}"></td>
<td><input value="${fmt(d.‡∏Å‡∏≥‡πÑ‡∏£)}"></td>
<td><input value="${fmt(d.‡∏•‡∏ö)}"></td>
<td>0</td>
<td><button onclick="removeRow(this)">X</button></td>`;
});
calc();
updateEditMode();
});

document.addEventListener("input",calc);

</script>
</body>
</html>
