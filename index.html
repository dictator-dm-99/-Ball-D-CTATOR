<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>D!CTATOR</title>

<style>
body{
  background:black;
  color:white;
  font-family:Arial;
  text-align:center;
}

/* logo animation */
.logoText{
  font-size:48px;
  font-weight:bold;
  margin:20px;
  animation:float 3s ease-in-out infinite;
}
@keyframes float{
  0%{transform:translateY(0)}
  50%{transform:translateY(-6px)}
  100%{transform:translateY(0)}
}

/* login box */
#loginBox input{
  width:140px;
  padding:5px;
  margin:2px;
}

/* table */
table{
  width:90%;
  margin:auto;
  border-collapse:collapse;
}
th{
  background:#111;
  color:white;
  padding:8px;
  border:1px solid #555;
}
td{
  background:white;
  color:black;
  padding:6px;
  border:1px solid #555;
}
tfoot td{
  background:black;
  color:white;
  font-weight:bold;
}

/* input box inside cell */
td input{
  width:90%;
  padding:3px;
  border:1px solid #aaa;
  border-radius:4px;
  text-align:center;
  background:#fafafa;
}

/* audit */
#logBox{
  display:none;
  margin:20px;
  border:1px solid #555;
  padding:10px;
  height:150px;
  overflow:auto;
  background:#111;
  font-size:12px;
  text-align:left;
}
</style>
</head>

<body>

<div class="logoText">D<span style="color:red">!</span>CTATOR</div>
<h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏ö‡∏≠‡∏•</h2>

<div id="loginBox">
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<br>

<button id="addBtn" onclick="addDay()" disabled>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô</button>
<button id="saveBtn" onclick="save()" disabled>üíæ Save</button>
<button id="toggleLog" onclick="toggleLog()" disabled>Audit Log</button>

<table id="table">
<thead>
<tr>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th>‡∏ó‡∏∏‡∏ô</th>
<th>‡∏Å‡∏≥‡πÑ‡∏£</th>
<th>‡∏•‡∏ö</th>
<th>‡∏£‡∏ß‡∏°</th>
<th>‡∏•‡∏ö‡∏ß‡∏±‡∏ô</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
<td id="sum‡∏ó‡∏∏‡∏ô">0</td>
<td id="sum‡∏Å‡∏≥‡πÑ‡∏£">0</td>
<td id="sum‡∏•‡∏ö">0</td>
<td id="sum‡∏£‡∏ß‡∏°">0</td>
<td></td>
</tr>
</tfoot>
</table>

<h3 id="logTitle" style="display:none">Audit Log</h3>
<div id="logBox"></div>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue, get, push, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig={
apiKey:"AIzaSyDZ0iBQX1uJz_gf23M6gn8yQ6S90lGYDOc",
authDomain:"dictator-ball.firebaseapp.com",
databaseURL:"https://dictator-ball-default-rtdb.asia-southeast1.firebasedatabase.app",
projectId:"dictator-ball"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const dataRef=ref(db,"table");
const logRef=ref(db,"audit");
const sessionRef=ref(db,"sessions");

/* accounts */
const accounts={
"Pim888_":"dictator_888_pim",
"Yohan888_":"dictator_yohan_888",
"Jo888_":"Jo_dictator_888",
"Jwish888_":"dictator_Jwish888_",
"Joommeng_":"Joommeng888"
};

let admin=false;
let currentUser="";
let deviceId=localStorage.getItem("dev")||crypto.randomUUID();
localStorage.setItem("dev",deviceId);

/* auto login */
let rememberedUser=localStorage.getItem("loginUser");
if(rememberedUser){
admin=true;
currentUser=rememberedUser;
unlockAdmin();
}

/* login */
window.login=async function(){
let u=user.value,p=pass.value;
if(accounts[u]!==p){alert("Wrong login");return;}

let s=await get(ref(db,"sessions/"+u));
if(s.exists()&&s.val()!==deviceId){
alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà");
return;
}

set(ref(db,"sessions/"+u),deviceId);

admin=true;
currentUser=u;
localStorage.setItem("loginUser",u);

unlockAdmin();
log("LOGIN");
}

/* logout */
window.logout=async function(){
if(currentUser){
await remove(ref(db,"sessions/"+currentUser));
log("LOGOUT");
}
admin=false;
currentUser="";
localStorage.removeItem("loginUser");
lockAdmin();
}

/* admin lock/unlock */
function unlockAdmin(){
addBtn.disabled=false;
saveBtn.disabled=false;
toggleLog.disabled=false;
}
function lockAdmin(){
addBtn.disabled=true;
saveBtn.disabled=true;
toggleLog.disabled=true;
logBox.style.display="none";
logTitle.style.display="none";
}

/* audit toggle */
window.toggleLog=function(){
if(!admin) return;
let show=logBox.style.display==="none";
logBox.style.display=show?"block":"none";
logTitle.style.display=show?"block":"none";
}

/* audit */
function log(action){
push(logRef,{
user:currentUser,
action:action,
time:new Date().toLocaleString()
});
}

onValue(logRef,s=>{
if(!admin) return;
let data=s.val();
if(!data) return;

logBox.innerHTML="";
Object.values(data).slice(-20).reverse().forEach(d=>{
logBox.innerHTML+=`<div>[${d.time}] ${d.user} ‚Üí ${d.action}</div>`;
});
});

/* helpers */
function fmt(n){return Number(n).toLocaleString();}
function parse(n){return Number(String(n).replace(/,/g,""))||0;}

/* add row */
window.addDay=function(){
if(!admin) return;
let r=document.querySelector("#table tbody").insertRow();
r.innerHTML=`
<td><input type=date></td>
<td><input value=0></td>
<td><input value=0></td>
<td><input value=0></td>
<td>0</td>
<td><button onclick="removeRow(this)">X</button></td>`;
log("ADD ROW");
calc();
}

/* remove row */
window.removeRow=function(b){
if(!admin) return;
b.parentNode.parentNode.remove();
log("DELETE ROW");
calc();
}

/* calc */
function calc(){
let rows=document.querySelectorAll("#table tbody tr");
let s1=0,s2=0,s3=0,s4=0;

rows.forEach(r=>{
let a=parse(r.cells[1].children[0].value);
let b=parse(r.cells[2].children[0].value);
let c=parse(r.cells[3].children[0].value);

r.cells[1].children[0].value=fmt(a);
r.cells[2].children[0].value=fmt(b);
r.cells[3].children[0].value=fmt(c);

let sum=a+b-c;
r.cells[4].innerText=fmt(sum);

s1+=a;s2+=b;s3+=c;s4+=sum;
});

sum‡∏ó‡∏∏‡∏ô.innerText=fmt(s1);
sum‡∏Å‡∏≥‡πÑ‡∏£.innerText=fmt(s2);
sum‡∏•‡∏ö.innerText=fmt(s3);
sum‡∏£‡∏ß‡∏°.innerText=fmt(s4);
}

/* save */
window.save=function(){
if(!admin) return;

let rows=document.querySelectorAll("#table tbody tr");
let data=[];
rows.forEach(r=>{
data.push({
date:r.cells[0].children[0].value,
‡∏ó‡∏∏‡∏ô:parse(r.cells[1].children[0].value),
‡∏Å‡∏≥‡πÑ‡∏£:parse(r.cells[2].children[0].value),
‡∏•‡∏ö:parse(r.cells[3].children[0].value)
});
});

set(dataRef,data);
log("SAVE TABLE");
alert("Saved!");
}

/* load */
onValue(dataRef,s=>{
let data=s.val();
if(!data) return;
let tbody=document.querySelector("#table tbody");
tbody.innerHTML="";
data.forEach(d=>{
let r=tbody.insertRow();
r.innerHTML=`
<td><input type=date value="${d.date}"></td>
<td><input value="${fmt(d.‡∏ó‡∏∏‡∏ô)}"></td>
<td><input value="${fmt(d.‡∏Å‡∏≥‡πÑ‡∏£)}"></td>
<td><input value="${fmt(d.-)}"></td>
<td>0</td>
<td><button onclick="removeRow(this)">X</button></td>`;
});
calc();
});

document.addEventListener("input",calc);

</script>
</body>
</html>
