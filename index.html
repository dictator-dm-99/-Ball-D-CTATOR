<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DICTATOR</title>

<style>
body{
 background:black;
 color:white;
 font-family:Arial;
 text-align:center;
}

.logoText{
 font-size:48px;
 font-weight:bold;
 margin:20px;
 animation:logoMove 2s infinite alternate;
}

@keyframes logoMove{
 from{transform:translateY(0)}
 to{transform:translateY(8px)}
}

table{
 width:90%;
 margin:auto;
 border-collapse:collapse;
}

th,td{
 border:1px solid #444;
 padding:6px;
}

td{background:white;color:black;}

tfoot td{
 background:black;
 color:white;
 font-weight:bold;
}

.profitNum{
 color:#00ff88;
 font-weight:bold;
 animation:bounce .6s ease;
 display:inline-block;
}

.lossNum{
 color:red;
 font-weight:bold;
 animation:blink 1s infinite;
}

@keyframes bounce{
 0%{transform:scale(1)}
 50%{transform:scale(1.4)}
 100%{transform:scale(1)}
}

@keyframes blink{
 50%{opacity:0}
}

#auditBox{
 display:none;
 width:90%;
 margin:20px auto;
 background:#111;
 border:1px solid #333;
 padding:10px;
 text-align:left;
 font-size:12px;
}

input{
 width:120px;
 padding:4px;
}

button{
 padding:5px 10px;
 margin:2px;
}
</style>
</head>

<body>

<div class="logoText">D<span style="color:red">!</span>CTATOR</div>
<h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏ö‡∏≠‡∏•</h2>

<div id="loginBox">
<input id="user" placeholder="Username">
<input id="pass" type="password" placeholder="Password">
<button onclick="login()">Login</button>
<button onclick="logout()">Logout</button>
</div>

<br>

<button onclick="addRow()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô</button>
<button onclick="save()">üíæ Save</button>
<button onclick="toggleAudit()">üìú Audit Log</button>

<table id="table">
<thead>
<tr>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th>‡∏ó‡∏∏‡∏ô</th>
<th>‡∏Å‡∏≥‡πÑ‡∏£</th>
<th>‡∏•‡∏ö</th>
<th>‡∏£‡∏ß‡∏°</th>
<th>‡∏•‡∏ö‡∏ß‡∏±‡∏ô</th>
</tr>
</thead>
<tbody></tbody>

<tfoot>
<tr>
<td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
<td id="sum‡∏ó‡∏∏‡∏ô"></td>
<td id="sum‡∏Å‡∏≥‡πÑ‡∏£"></td>
<td id="sum‡∏•‡∏ö"></td>
<td id="sum‡∏£‡∏ß‡∏°"></td>
<td></td>
</tr>
</tfoot>
</table>

<div id="auditBox"></div>

<script type="module">
import {initializeApp} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {getDatabase,ref,set,onValue,push,remove} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig={
 apiKey:"AIzaSyDZ0iBQX1uJz_gf23M6gn8yQ6S90lGYDOc",
 authDomain:"dictator-ball.firebaseapp.com",
 databaseURL:"https://dictator-ball-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"dictator-ball"
};

const app=initializeApp(firebaseConfig);
const db=getDatabase(app);

const dataRef=ref(db,"table");
const sessionRef=ref(db,"sessions");
const logRef=ref(db,"audit");

const accounts={
 Pim888_:"dictator_888_pim",
 Yohan888_:"dictator_yohan_888",
 Jo888_:"Jo_dictator_888",
 Jwish888_:"dictator_Jwish888_",
 Joommeng_:"Joommeng888"
};

let currentUser=null;

function log(action){
 if(!currentUser)return;
 push(logRef,{
 user:currentUser,
 action,
 time:new Date().toLocaleString()
 });
}

window.login=()=>{
 let u=user.value;
 let p=pass.value;

 if(accounts[u]!==p){
  alert("‡∏ú‡∏¥‡∏î");
  return;
 }

 onValue(ref(db,"sessions/"+u),(s)=>{
  if(s.exists() && s.val()!==navigator.userAgent){
   alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
   return;
  }

  set(ref(db,"sessions/"+u),navigator.userAgent);
  currentUser=u;
  log("LOGIN");
 });
};

window.logout=()=>{
 if(!currentUser)return;
 remove(ref(db,"sessions/"+currentUser));
 log("LOGOUT");
 currentUser=null;
};

window.addRow=()=>{
 let tbody=document.querySelector("#table tbody");
 let r=tbody.insertRow();
 r.innerHTML=`
<td><input type="date"></td>
<td><input value="0"></td>
<td><input value="0"></td>
<td><input value="0"></td>
<td><span>0</span></td>
<td><button onclick="this.parentNode.parentNode.remove();calc()">X</button></td>`;
};

function fmt(n){return n.toLocaleString();}
function parse(v){return parseInt(v.replace(/,/g,''))||0;}

window.calc=()=>{
 let rows=document.querySelectorAll("#table tbody tr");
 let st=0,sg=0,sl=0,sr=0;

 rows.forEach(r=>{
  let t=parse(r.cells[1].children[0].value);
  let g=parse(r.cells[2].children[0].value);
  let l=parse(r.cells[3].children[0].value);

  r.cells[1].children[0].value=fmt(t);
  r.cells[2].children[0].value=fmt(g);
  r.cells[3].children[0].value=fmt(l);

  r.cells[2].children[0].className="profitNum";
  r.cells[3].children[0].className="lossNum";

  let sum=t+g-l;
  r.cells[4].innerText=fmt(sum);

  st+=t; sg+=g; sl+=l; sr+=sum;
 });

 sum‡∏ó‡∏∏‡∏ô.innerText=fmt(st);
 sum‡∏Å‡∏≥‡πÑ‡∏£.innerText=fmt(sg);
 sum‡∏•‡∏ö.innerText=fmt(sl);
 sum‡∏£‡∏ß‡∏°.innerText=fmt(sr);
};

document.addEventListener("input",calc);

window.save=()=>{
 let rows=document.querySelectorAll("#table tbody tr");
 let data=[];
 rows.forEach(r=>{
  data.push({
   date:r.cells[0].children[0].value,
   t:parse(r.cells[1].children[0].value),
   g:parse(r.cells[2].children[0].value),
   l:parse(r.cells[3].children[0].value)
  });
 });
 set(dataRef,data);
 log("SAVE TABLE");
};

onValue(dataRef,(snap)=>{
 let data=snap.val()||[];
 let tbody=document.querySelector("#table tbody");
 tbody.innerHTML="";
 data.forEach(d=>{
  let r=tbody.insertRow();
  r.innerHTML=`
<td><input type="date" value="${d.date}"></td>
<td><input value="${fmt(d.t)}"></td>
<td><input value="${fmt(d.g)}"></td>
<td><input value="${fmt(d.l)}"></td>
<td><span>0</span></td>
<td><button onclick="this.parentNode.parentNode.remove();calc()">X</button></td>`;
 });
 calc();
});

onValue(logRef,(s)=>{
 let box=auditBox;
 box.innerHTML="";
 let logs=s.val()||{};
 Object.values(logs).reverse().forEach(l=>{
  box.innerHTML+=`[${l.time}] ${l.user} ‚Üí ${l.action}<br>`;
 });
});

window.toggleAudit=()=>{
 auditBox.style.display=
 auditBox.style.display==="none"?"block":"none";
};
</script>
</body>
</html>
