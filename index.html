<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>D!CTATOR</title>

<style>
body{
  background:black;
  color:white;
  font-family:Arial;
  text-align:center;
}

/* logo */
.logoText{
  font-size:48px;
  font-weight:bold;
  margin:20px;
  animation:shake 2s infinite;
}

@keyframes shake{
  0%{transform:translate(0)}
  25%{transform:translate(1px,0)}
  50%{transform:translate(-1px,0)}
  75%{transform:translate(1px,0)}
  100%{transform:translate(0)}
}

/* login box */
#loginBox{
  margin:20px;
}

input, button{
  padding:6px;
  margin:5px;
}

table{
  width:90%;
  margin:auto;
  border-collapse:collapse;
}

th{
  background:#111;
  color:white;
  padding:8px;
  border:1px solid #555;
}

td{
  background:white;
  color:black;
  padding:6px;
  border:1px solid #555;
}

tfoot td{
  background:black;
  color:white;
  font-weight:bold;
}

input{
  width:100%;
  border:none;
  text-align:center;
  background:white;
}
</style>
</head>

<body>

<div class="logoText">D<span style="color:red">!</span>CTATOR</div>
<h2>‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏¢‡∏≠‡∏î‡∏ö‡∏≠‡∏•</h2>

<div id="loginBox">
  <input id="user" placeholder="Username">
  <input id="pass" type="password" placeholder="Password">
  <button onclick="login()">Login Admin</button>
  <button onclick="logout()">Logout</button>
</div>

<button id="addBtn" onclick="addDay()" disabled>+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô</button>
<button id="saveBtn" onclick="save()" disabled>üíæ Save</button>

<table id="table">
<thead>
<tr>
<th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
<th>‡∏ó‡∏∏‡∏ô</th>
<th>‡∏Å‡∏≥‡πÑ‡∏£</th>
<th>-</th>
<th>‡∏£‡∏ß‡∏°</th>
<th>‡∏•‡∏ö‡∏ß‡∏±‡∏ô</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr>
<td>‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td>
<td id="sum‡∏ó‡∏∏‡∏ô">0</td>
<td id="sum‡∏Å‡∏≥‡πÑ‡∏£">0</td>
<td id="sum‡∏•‡∏ö">0</td>
<td id="sum‡∏£‡∏ß‡∏°">0</td>
<td></td>
</tr>
</tfoot>
</table>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getDatabase, ref, set, onValue, get, remove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyDZ0iBQX1uJz_gf23M6gn8yQ6S90lGYDOc",
  authDomain: "dictator-ball.firebaseapp.com",
  databaseURL: "https://dictator-ball-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "dictator-ball",
  storageBucket: "dictator-ball.appspot.com",
  messagingSenderId: "533340357926",
  appId: "1:533340357926:web:a1eb15b77c335a7a57ade7"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const dataRef = ref(db,"table");
const sessionRef = ref(db,"sessions");

/* ===== ACCOUNT ===== */
const accounts = {
"Pim888_":"dictator_888_pim",
"Yohan888_":"dictator_yohan_888",
"Jo888_":"Jo_dictator_888",
"Jwish888_":"dictator_Jwish888_",
"Joommeng_":"Joommeng888"
};

let admin=false;
let deviceId = localStorage.getItem("deviceId") || crypto.randomUUID();
localStorage.setItem("deviceId",deviceId);

/* ===== LOGIN ===== */
window.login = async function(){

let u=user.value;
let p=pass.value;

if(accounts[u]!==p){
alert("Wrong login");
return;
}

let snap = await get(ref(db,"sessions/"+u));

if(snap.exists() && snap.val()!==deviceId){
alert("‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ô‡∏µ‡πâ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà!");
return;
}

set(ref(db,"sessions/"+u),deviceId);

admin=true;
addBtn.disabled=false;
saveBtn.disabled=false;

alert("Admin mode");
}

window.logout=function(){
admin=false;
addBtn.disabled=true;
saveBtn.disabled=true;
alert("Logout");
}

/* ===== TABLE ===== */

function fmt(n){return Number(n).toLocaleString();}
function parse(n){return Number(String(n).replace(/,/g,""))||0;}

window.addDay=function(){
if(!admin) return;
let tbody=document.querySelector("#table tbody");
let r=tbody.insertRow();
r.innerHTML=`
<td><input type="date"></td>
<td><input value="0"></td>
<td><input value="0"></td>
<td><input value="0"></td>
<td>0</td>
<td><button onclick="removeRow(this)">X</button></td>`;
calc();
}

window.removeRow=function(btn){
if(!admin) return;
btn.parentNode.parentNode.remove();
calc();
}

function calc(){
let rows=document.querySelectorAll("#table tbody tr");
let s1=0,s2=0,s3=0,s4=0;

rows.forEach(r=>{
let a=parse(r.cells[1].children[0].value);
let b=parse(r.cells[2].children[0].value);
let c=parse(r.cells[3].children[0].value);

r.cells[1].children[0].value=fmt(a);
r.cells[2].children[0].value=fmt(b);
r.cells[3].children[0].value=fmt(c);

let sum=a+b-c;
r.cells[4].innerText=fmt(sum);

s1+=a;s2+=b;s3+=c;s4+=sum;
});

sum‡∏ó‡∏∏‡∏ô.innerText=fmt(s1);
sum‡∏Å‡∏≥‡πÑ‡∏£.innerText=fmt(s2);
sum‡∏•‡∏ö.innerText=fmt(s3);
sum‡∏£‡∏ß‡∏°.innerText=fmt(s4);
}

window.save=function(){
if(!admin) return;

let rows=document.querySelectorAll("#table tbody tr");
let data=[];

rows.forEach(r=>{
data.push({
date:r.cells[0].children[0].value,
‡∏ó‡∏∏‡∏ô:parse(r.cells[1].children[0].value),
‡∏Å‡∏≥‡πÑ‡∏£:parse(r.cells[2].children[0].value),
‡∏•‡∏ö:parse(r.cells[3].children[0].value)
});
});

set(dataRef,data);
alert("Saved!");
}

onValue(dataRef,snap=>{
let data=snap.val();
if(!data) return;

let tbody=document.querySelector("#table tbody");
tbody.innerHTML="";

data.forEach(d=>{
let r=tbody.insertRow();
r.innerHTML=`
<td><input type="date" value="${d.date}"></td>
<td><input value="${fmt(d.‡∏ó‡∏∏‡∏ô)}"></td>
<td><input value="${fmt(d.‡∏Å‡∏≥‡πÑ‡∏£)}"></td>
<td><input value="${fmt(d.‡∏•‡∏ö)}"></td>
<td>0</td>
<td><button onclick="removeRow(this)">X</button></td>`;
});

calc();
});

document.addEventListener("input",calc);

</script>
</body>
</html>
